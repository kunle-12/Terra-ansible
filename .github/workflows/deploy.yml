name: Deploy and Configure Azure VM

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TF_IN_AUTOMATION: true

jobs:
  deploy:
    name: Provision VM and Run Ansible
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        id: tf
        run: |
          terraform apply -var-file="env/dev.tfvars" -auto-approve \
            -no-color \
            -input=false

      - name: Save Private Key to File
        run: |
          echo "${{ steps.tf.outputs.private_key_pem }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Generate dynamic Ansible inventory
        id: make_inventory
        run: |
          echo "[azure_vm]" > inventory.ini
          echo "${{ steps.tf.outputs.vm_private_ip }}" >> inventory.ini
          echo "" >> inventory.ini
          echo "[azure_vm:vars]" >> inventory.ini
          echo "ansible_user=${{ secrets.VM_USERNAME }}" >> inventory.ini
          echo "ansible_ssh_private_key_file=private_key.pem" >> inventory.ini

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible

      - name: Wait for SSH to become available
        run: |
          IP="${{ steps.tf.outputs.vm_private_ip }}"
          for i in {1..60}; do
            nc -z "$IP" 22 && echo "SSH is available" && exit 0
            echo "Waiting for SSH on $IP... ($i/60)"
            sleep 5
          done
          echo "Timed out waiting for SSH"
          exit 1

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini ansible/site.yml
